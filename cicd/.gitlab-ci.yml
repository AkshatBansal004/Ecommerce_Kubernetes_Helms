stages:
  - validate
  - build
  - publish

workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

default:
  interruptible: true

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_HOST: "tcp://docker:2376"

cache:
  key: "${CI_PROJECT_NAME}-pip"
  paths:
    - .cache/pip

python_checks:
  stage: validate
  image: python:3.11-slim
  script:
    - python --version
    - pip install --upgrade pip
    - |
      for svc in user-service product-service order-service; do
        echo "Checking services/$svc"
        pip install -r "services/$svc/requirements.txt"
        python -m compileall "services/$svc/app"
      done
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

helm_checks:
  stage: validate
  image:
    name: alpine/helm:3.15.4
    entrypoint: [""]
  script:
    - helm version
    - helm dependency update helm/ecommerce-platform
    - helm lint helm/user-svc
    - helm lint helm/product-svc
    - helm lint helm/order-svc
    - helm lint helm/ecommerce-platform
    - helm template shop helm/ecommerce-platform >/dev/null
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

docker_build:
  stage: build
  image: docker:27.3.1-cli
  services:
    - name: docker:27.3.1-dind
      command:
        - --tls=true
  script:
    - docker version
    - docker build -t "$CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA" services/user-service
    - docker build -t "$CI_REGISTRY_IMAGE/product-service:$CI_COMMIT_SHORT_SHA" services/product-service
    - docker build -t "$CI_REGISTRY_IMAGE/order-service:$CI_COMMIT_SHORT_SHA" services/order-service
    - docker build -t "$CI_REGISTRY_IMAGE/api-gateway:$CI_COMMIT_SHORT_SHA" -f api-gateway/Dockerfile .
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

docker_publish:
  stage: publish
  image: docker:27.3.1-cli
  services:
    - name: docker:27.3.1-dind
      command:
        - --tls=true
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    - |
      IMAGE_TAG="${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}"
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ] && [ -n "$CI_COMMIT_BRANCH" ]; then
        IMAGE_TAG="latest"
      fi
      docker build -t "$CI_REGISTRY_IMAGE/user-service:$IMAGE_TAG" services/user-service
      docker build -t "$CI_REGISTRY_IMAGE/product-service:$IMAGE_TAG" services/product-service
      docker build -t "$CI_REGISTRY_IMAGE/order-service:$IMAGE_TAG" services/order-service
      docker build -t "$CI_REGISTRY_IMAGE/api-gateway:$IMAGE_TAG" -f api-gateway/Dockerfile .
      docker push "$CI_REGISTRY_IMAGE/user-service:$IMAGE_TAG"
      docker push "$CI_REGISTRY_IMAGE/product-service:$IMAGE_TAG"
      docker push "$CI_REGISTRY_IMAGE/order-service:$IMAGE_TAG"
      docker push "$CI_REGISTRY_IMAGE/api-gateway:$IMAGE_TAG"
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
